<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="9/19/2024 5:14:15 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="BCODBRENESM_P"
  DTS:CreatorName="COMBCOCR\daniel.brenesm"
  DTS:DTSID="{CA9032D7-FC79-45F4-87B3-9EFA67E6F4B4}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="16.0.5556.0"
  DTS:LocaleID="5130"
  DTS:ObjectName="Package"
  DTS:PackageType="5"
  DTS:VersionBuild="1"
  DTS:VersionGUID="{17D0F5BA-FF89-487C-9C7C-678D238DF733}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:Variables />
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\LIMPIAR TABLAS"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tarea Ejecutar SQL"
      DTS:DTSID="{5626FB27-ACA6-4ED8-B5C3-AEDEF2111D76}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="LIMPIAR TABLAS"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; SQL Server 2022; © 2022 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\OBTENER DATOS"
      DTS:CreationName="Microsoft.Pipeline"
      DTS:Description="Data Flow Task"
      DTS:DTSID="{890337BC-9B3C-48C9-965F-FB8AC6017E1C}"
      DTS:ExecutableType="Microsoft.Pipeline"
      DTS:LocaleID="-1"
      DTS:ObjectName="OBTENER DATOS"
      DTS:TaskContact="Performs high-performance data extraction, transformation and loading;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1">
      <DTS:Variables />
      <DTS:ObjectData>
        <pipeline
          version="1">
          <components>
            <component
              refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES)"
              componentClassID="Microsoft.OLEDBSource"
              contactInfo="OLE DB Source;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;7"
              description="OLE DB Source"
              name="OBTENER DATOS LEADS (CLIENTES EXISTENTES)"
              usesDispositions="true"
              version="7">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset"></property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor">WITH DESCOMPONER_DESC AS (
	SELECT ID_OPORTUNIDAD,

		   value AS PARTE,
		   CHAR(ROW_NUMBER() OVER(PARTITION BY ID_OPORTUNIDAD ORDER BY (SELECT  NULL))+64) AS PARTE_LETRA

	FROM (SELECT ROW_ID AS ID_OPORTUNIDAD, REPLACE(DESC_TEXT,'/','-') AS DESC_TEXT FROM [DWSiebel].[PAN].[S_OPTY] WHERE OPTY_CD = 'PREAPROBADO' and NAME LIKE '%SEP2024%' and NAME LIKE '%PPA%' and NAME LIKE 'PANC%' and CREATED_BY = '1-E1CM-0')B 
	CROSS APPLY string_split(DESC_TEXT,'-')
),
DESCOMPONER_NAME AS (
	SELECT ID_OPORTUNIDAD,
			
		   VALUE AS PARTE_NAME,
		   ROW_NUMBER() OVER(PARTITION BY ID_OPORTUNIDAD ORDER BY (SELECT  NULL)) AS PARTE_NUM
	FROM (SELECT ROW_ID AS ID_OPORTUNIDAD, REPLACE(NAME,'/','-') as NAME FROM [DWSiebel].[PAN].[S_OPTY] WHERE OPTY_CD = 'PREAPROBADO' and NAME LIKE '%SEP2024%' and NAME LIKE '%PPA%' and NAME LIKE 'PANC%' and CREATED_BY = '1-E1CM-0')B 
	CROSS APPLY string_split(NAME,'-')
)
SELECT * FROM (
SELECT A.ID_OPORTUNIDAD,

	   case when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles gold') then 'CONNECTMILES GOLD AMEX'
			when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles black') then 'CONNECTMILES BLACK AMEX'
			when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles platinum') then 'CONNECTMILES PLATINUM AMEX'
			WHEN LOWER(A.G) IN ('ofrecer: smartcash amex clásica','ofrecer:smartcash amex clásica') THEN 'SMARTCASH CLASICA AMEX'
			WHEN LOWER(A.G) = 'ofrecer:the platinum card amex' THEN 'THE PLATINUM CARD AMEX'
			WHEN LOWER(A.G) = 'ofrecer:gold card amex' THEN 'GOLD CARD AMEX'
			WHEN LOWER(A.G) IN ('ofrecer: master cardamex clásica','ofrecer:master card amex clásica','ofrecer: master card amex clásica') THEN 'CLASICA MASTERCARD'
			WHEN LOWER(A.G) = 'ofrecer:pricesmart' THEN 'PRICESMART VISA'
			WHEN LOWER(A.G) = 'ofrecer:blue centurion amex' THEN 'BLUE CENTURION AMEX'
			END AS NOMBRE_TARJETA,

		CASE WHEN LOWER(A.G) IN ('ofrecer:connectmiles amex + amex connectmiles gold','ofrecer:connectmiles amex + amex connectmiles black','ofrecer:connectmiles amex + amex connectmiles platinum','ofrecer: smartcash amex clásica','ofrecer:smartcash amex clásica','ofrecer:the platinum card amex','ofrecer:gold card amex','ofrecer:blue centurion amex') THEN 'AMEX'
			 WHEN LOWER(A.G) IN ('ofrecer: master cardamex clásica','ofrecer:master card amex clásica','ofrecer: master card amex clásica') THEN 'MASTERCARD' 
			 WHEN LOWER(A.G) IN ('ofrecer:pricesmart') THEN 'VISA'
			 END AS MARCA,

	   CASE WHEN A.h IS NOT NULL THEN SUBSTRING(A.h,5,LEN(A.H)) ELSE A.h END AS LIMITE_APROBADO, 

	   CASE WHEN LTRIM(B.[8]) LIKE 'XSELLING%' THEN 'XSELLING'
			WHEN LTRIM(B.[8]) LIKE 'PLANILLA%' THEN 'PLANILLA'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE EXCLIENTE%' THEN 'EXCLIENTES'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE PRICESMART%' THEN 'PRICESMART'
			WHEN LTRIM(B.[8]) LIKE 'PPA COPA%' THEN 'COPA'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE KASH%' THEN 'KASH'
			ELSE LTRIM(B.[8])
			END AS NOMBRE_CAMPAÑA,

	   case when B.[10]	IS NULL THEN B.[9]
			ELSE B.[9] + B.[10] + B.[11] END AS ID_CLIENTE
FROM(
		SELECT *
		FROM DESCOMPONER_DESC
		pivot(
				MAX(PARTE)
				FOR PARTE_LETRA IN ([a],[b],[c],[d],[e],[f],[g],[h],[i],[j],[k],[l],[m])
		) as pivot_desc) A
LEFT JOIN (
			SELECT *
			FROM DESCOMPONER_NAME
			pivot(
					MAX(PARTE_NAME)
					FOR PARTE_NUM IN ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11])
			) as pivot_name 
) B on A.ID_OPORTUNIDAD = B.ID_OPORTUNIDAD
) A
WHERE NOMBRE_CAMPAÑA IN ('XSELLING','PLANILLA')</property>
                <property
                  dataType="System.String"
                  description="The variable that contains the SQL command to be executed."
                  name="SqlCommandVariable"></property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">2</property>
                <property
                  dataType="System.String"
                  description="The mappings between the parameters in the SQL command and variables."
                  name="ParameterMapping"></property>
              </properties>
              <connections>
                <connection
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Connections[OleDbConnection]"
                  connectionManagerID="{749EA376-6BA2-4B45-BC77-2C2E4D4107AE}:external"
                  connectionManagerRefId="Project.ConnectionManagers[DWSIEBEL]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <outputs>
                <output
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output]"
                  name="OLE DB Source Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_OPORTUNIDAD]"
                      length="15"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[ID_OPORTUNIDAD]"
                      name="ID_OPORTUNIDAD"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_TARJETA]"
                      length="26"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_TARJETA]"
                      name="NOMBRE_TARJETA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[MARCA]"
                      length="10"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[MARCA]"
                      name="MARCA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[LIMITE_APROBADO]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[LIMITE_APROBADO]"
                      name="LIMITE_APROBADO"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_CAMPAÑA]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_CAMPAÑA]"
                      name="NOMBRE_CAMPAÑA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_CLIENTE]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].Columns[ID_CLIENTE]"
                      name="ID_CLIENTE"
                      truncationRowDisposition="FailComponent" />
                  </outputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      length="15"
                      name="ID_OPORTUNIDAD" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      length="26"
                      name="NOMBRE_TARJETA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="MARCA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="LIMITE_APROBADO" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="NOMBRE_CAMPAÑA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="ID_CLIENTE" />
                  </externalMetadataColumns>
                </output>
                <output
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output]"
                  isErrorOut="true"
                  name="OLE DB Source Error Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      length="15"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ID_OPORTUNIDAD]"
                      name="ID_OPORTUNIDAD" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      length="26"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_TARJETA]"
                      name="NOMBRE_TARJETA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[MARCA]"
                      name="MARCA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[LIMITE_APROBADO]"
                      name="LIMITE_APROBADO" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_CAMPAÑA]"
                      name="NOMBRE_CAMPAÑA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ID_CLIENTE]"
                      name="ID_CLIENTE" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES).Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
            <component
              refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES)"
              componentClassID="Microsoft.OLEDBSource"
              contactInfo="OLE DB Source;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;7"
              description="OLE DB Source"
              name="OBTENER DATOS LEADS (NUEVOS CLIENTES)"
              usesDispositions="true"
              version="7">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset"></property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor">WITH DESCOMPONER_DESC AS (
	SELECT ID_OPORTUNIDAD,

		   value AS PARTE,
		   CHAR(ROW_NUMBER() OVER(PARTITION BY ID_OPORTUNIDAD ORDER BY (SELECT  NULL))+64) AS PARTE_LETRA

	FROM (SELECT ROW_ID AS ID_OPORTUNIDAD, REPLACE(DESC_TEXT,'/','-') AS DESC_TEXT FROM [DWSiebel].[PAN].[S_OPTY] WHERE OPTY_CD = 'PREAPROBADO' and NAME LIKE '%SEP2024%' and NAME LIKE '%PPA%' and NAME LIKE 'PANC%' and CREATED_BY = '1-E1CM-0')B 
	CROSS APPLY string_split(DESC_TEXT,'-')
),
DESCOMPONER_NAME AS (
	SELECT ID_OPORTUNIDAD,
			
		   VALUE AS PARTE_NAME,
		   ROW_NUMBER() OVER(PARTITION BY ID_OPORTUNIDAD ORDER BY (SELECT  NULL)) AS PARTE_NUM
	FROM (SELECT ROW_ID AS ID_OPORTUNIDAD, REPLACE(NAME,'/','-') as NAME FROM [DWSiebel].[PAN].[S_OPTY] WHERE OPTY_CD = 'PREAPROBADO' and NAME LIKE '%SEP2024%' and NAME LIKE '%PPA%' and NAME LIKE 'PANC%' and CREATED_BY = '1-E1CM-0')B 
	CROSS APPLY string_split(NAME,'-')
)
SELECT * FROM (
SELECT A.ID_OPORTUNIDAD,

	   case when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles gold') then 'CONNECTMILES GOLD AMEX'
			when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles black') then 'CONNECTMILES BLACK AMEX'
			when LOWER(A.G) in ('ofrecer:connectmiles amex + amex connectmiles platinum') then 'CONNECTMILES PLATINUM AMEX'
			WHEN LOWER(A.G) IN ('ofrecer: smartcash amex clásica','ofrecer:smartcash amex clásica') THEN 'SMARTCASH CLASICA AMEX'
			WHEN LOWER(A.G) = 'ofrecer:the platinum card amex' THEN 'THE PLATINUM CARD AMEX'
			WHEN LOWER(A.G) = 'ofrecer:gold card amex' THEN 'GOLD CARD AMEX'
			WHEN LOWER(A.G) IN ('ofrecer: master cardamex clásica','ofrecer:master card amex clásica','ofrecer: master card amex clásica') THEN 'CLASICA MASTERCARD'
			WHEN LOWER(A.G) = 'ofrecer:pricesmart' THEN 'PRICESMART VISA'
			WHEN LOWER(A.G) = 'ofrecer:blue centurion amex' THEN 'BLUE CENTURION AMEX'
			END AS NOMBRE_TARJETA,

		CASE WHEN LOWER(A.G) IN ('ofrecer:connectmiles amex + amex connectmiles gold','ofrecer:connectmiles amex + amex connectmiles black','ofrecer:connectmiles amex + amex connectmiles platinum','ofrecer: smartcash amex clásica','ofrecer:smartcash amex clásica','ofrecer:the platinum card amex','ofrecer:gold card amex','ofrecer:blue centurion amex') THEN 'AMEX'
			 WHEN LOWER(A.G) IN ('ofrecer: master cardamex clásica','ofrecer:master card amex clásica','ofrecer: master card amex clásica') THEN 'MASTERCARD' 
			 WHEN LOWER(A.G) IN ('ofrecer:pricesmart') THEN 'VISA'
			 END AS MARCA,

	   CASE WHEN A.h IS NOT NULL THEN SUBSTRING(A.h,5,LEN(A.H)) ELSE A.h END AS LIMITE_APROBADO, 

	   CASE WHEN LTRIM(B.[8]) LIKE 'XSELLING%' THEN 'XSELLING'
			WHEN LTRIM(B.[8]) LIKE 'PLANILLA%' THEN 'PLANILLA'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE EXCLIENTE%' THEN 'EXCLIENTES'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE PRICESMART%' THEN 'PRICESMART'
			WHEN LTRIM(B.[8]) LIKE 'PPA COPA%' THEN 'COPA'
			WHEN LTRIM(B.[8]) LIKE 'PPA NUEVO CLIENTE KASH%' THEN 'KASH'
			ELSE LTRIM(B.[8])
			END AS NOMBRE_CAMPAÑA,

	   case when B.[10]	IS NULL THEN B.[9]
			ELSE B.[9] + B.[10] + B.[11] END AS ID_CLIENTE
FROM(
		SELECT *
		FROM DESCOMPONER_DESC
		pivot(
				MAX(PARTE)
				FOR PARTE_LETRA IN ([a],[b],[c],[d],[e],[f],[g],[h],[i],[j],[k],[l],[m])
		) as pivot_desc) A
LEFT JOIN (
			SELECT *
			FROM DESCOMPONER_NAME
			pivot(
					MAX(PARTE_NAME)
					FOR PARTE_NUM IN ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11])
			) as pivot_name 
) B on A.ID_OPORTUNIDAD = B.ID_OPORTUNIDAD
) A
WHERE NOMBRE_CAMPAÑA NOT IN ('XSELLING','PLANILLA')</property>
                <property
                  dataType="System.String"
                  description="The variable that contains the SQL command to be executed."
                  name="SqlCommandVariable"></property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">2</property>
                <property
                  dataType="System.String"
                  description="The mappings between the parameters in the SQL command and variables."
                  name="ParameterMapping"></property>
              </properties>
              <connections>
                <connection
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Connections[OleDbConnection]"
                  connectionManagerID="{749EA376-6BA2-4B45-BC77-2C2E4D4107AE}:external"
                  connectionManagerRefId="Project.ConnectionManagers[DWSIEBEL]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <outputs>
                <output
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output]"
                  name="OLE DB Source Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_OPORTUNIDAD]"
                      length="15"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[ID_OPORTUNIDAD]"
                      name="ID_OPORTUNIDAD"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_TARJETA]"
                      length="26"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_TARJETA]"
                      name="NOMBRE_TARJETA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[MARCA]"
                      length="10"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[MARCA]"
                      name="MARCA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[LIMITE_APROBADO]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[LIMITE_APROBADO]"
                      name="LIMITE_APROBADO"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_CAMPAÑA]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[NOMBRE_CAMPAÑA]"
                      name="NOMBRE_CAMPAÑA"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_CLIENTE]"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].Columns[ID_CLIENTE]"
                      name="ID_CLIENTE"
                      truncationRowDisposition="FailComponent" />
                  </outputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      length="15"
                      name="ID_OPORTUNIDAD" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      length="26"
                      name="NOMBRE_TARJETA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="MARCA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="LIMITE_APROBADO" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="NOMBRE_CAMPAÑA" />
                    <externalMetadataColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Output].ExternalColumns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      name="ID_CLIENTE" />
                  </externalMetadataColumns>
                </output>
                <output
                  refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output]"
                  isErrorOut="true"
                  name="OLE DB Source Error Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ID_OPORTUNIDAD]"
                      codePage="1252"
                      dataType="str"
                      length="15"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ID_OPORTUNIDAD]"
                      name="ID_OPORTUNIDAD" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_TARJETA]"
                      codePage="1252"
                      dataType="str"
                      length="26"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_TARJETA]"
                      name="NOMBRE_TARJETA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[MARCA]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[MARCA]"
                      name="MARCA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[LIMITE_APROBADO]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[LIMITE_APROBADO]"
                      name="LIMITE_APROBADO" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_CAMPAÑA]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[NOMBRE_CAMPAÑA]"
                      name="NOMBRE_CAMPAÑA" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ID_CLIENTE]"
                      codePage="1252"
                      dataType="str"
                      length="8000"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ID_CLIENTE]"
                      name="ID_CLIENTE" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES).Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
          </components>
        </pipeline>
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Restricción]"
      DTS:CreationName=""
      DTS:DTSID="{D54BF5FB-585B-4613-AEF3-9F2F6C8BF2D9}"
      DTS:From="Package\LIMPIAR TABLAS"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Restricción"
      DTS:To="Package\OBTENER DATOS" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--Esta sección CDATA contiene la información de diseño del paquete. Esta sección incluye información como, por ejemplo, las coordenadas (x,y), el ancho y el alto.-->
<!--Si edita manualmente esta sección y comete un error, puede eliminarlo. -->
<!--El paquete podrá cargarse normalmente, pero se perderá la información de diseño anterior y el diseñador reorganizará los elementos automáticamente en la superficie de diseño.-->
<Objects
  Version="8">
  <!--Cada uno de los nodos siguientes contiene propiedades que no afectan al comportamiento en tiempo de ejecución.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="173,42"
          Id="Package\OBTENER DATOS"
          TopLeft="348,193" />
        <NodeLayout
          Size="168,42"
          Id="Package\LIMPIAR TABLAS"
          TopLeft="354,78" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Restricción]"
          TopLeft="436.25,120">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,73"
              Start="0,0"
              End="0,65.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,65.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
  <TaskHost
    design-time-name="Package\OBTENER DATOS">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="347,42"
          Id="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES)"
          TopLeft="195,151" />
        <NodeLayout
          Size="325,42"
          Id="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES)"
          TopLeft="671,153" />
      </GraphLayout>
    </LayoutInfo>
  </TaskHost>
  <PipelineComponentMetadata
    design-time-name="Package\OBTENER DATOS\OBTENER DATOS LEADS (CLIENTES EXISTENTES)">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
  <PipelineComponentMetadata
    design-time-name="Package\OBTENER DATOS\OBTENER DATOS LEADS (NUEVOS CLIENTES)">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>